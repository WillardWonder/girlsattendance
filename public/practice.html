<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrestling Practice Timer & Stations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d111c; 
            color: white; 
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #3b82f6; border-radius: 10px; }
        .animate-pulse-fast { animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Make calendar and clock icons white in dark mode */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* Print Specific Styles */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white !important; color: black !important; }
            #print-area { display: block !important; padding: 20px; }
            .print-card { 
                border: 1px solid #ddd; 
                margin-bottom: 10px; 
                padding: 10px; 
                page-break-inside: avoid;
                color: black !important;
            }
            .print-header { border-bottom: 3px solid black; margin-bottom: 20px; padding-bottom: 10px; }
            .print-station-grid { 
                display: grid; 
                grid-template-columns: 1fr 1fr; 
                gap: 10px; 
                margin-top: 10px; 
            }
            .print-station-box { border: 1px solid #aaa; padding: 8px; font-size: 12px; }
        }
        
        #print-area { display: none; }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col no-print"></div>
    <div id="print-area"></div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-[100] transition-transform duration-300 transform translate-x-full no-print"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE CONFIGURATION (Girls Wrestling App) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCpaaZZaHAumlUxbshd2GVH9yIoZrszg9I",
            authDomain: "girls-wrestling-attendance.firebaseapp.com",
            projectId: "girls-wrestling-attendance",
            storageBucket: "girls-wrestling-attendance.firebasestorage.app",
            messagingSenderId: "509878173460",
            appId: "1:509878173460:web:d8d0133cbc5718ce9fcc01",
            measurementId: "G-CVY2FGY8L2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Use Global App ID if present, otherwise default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Make DB available globally
        window.db = db;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.collection = collection;
        window.writeBatch = writeBatch;
        window.serverTimestamp = serverTimestamp;
        window.appId = appId;
        window.currentUser = null;

        // --- Auth Logic ---
        window.performEmailLogin = async function(email, password, isRegister) {
            try {
                let userCredential;
                if (isRegister) {
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Create basic profile for new users
                    const user = userCredential.user;
                    const namePart = email.split('@')[0];
                    let fName = namePart.charAt(0).toUpperCase() + namePart.slice(1);
                    await setDoc(doc(db, "user_profiles", user.uid), { 
                        email: email, 
                        First_Name: fName, 
                        joined: new Date().toISOString()
                    });
                } else {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                }
                return { success: true, user: userCredential.user };
            } catch (error) {
                console.error("Auth failed", error);
                return { success: false, error: error.message };
            }
        };

        // Listen for auth state changes
        onAuthStateChanged(auth, (user) => {
            window.currentUser = user;
            window.dispatchEvent(new Event('auth-change'));
        });
    </script>

    <script>
        // --- CONFIGURATION ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNBJdt_3dEJs9pRukUfRduhd9IkY6n1ZcQ3MhkbqxJ8ThxFIusYb3aGYrCbUYhhkY/exec";
        const GOOGLE_CALENDAR_ID = "24d802fd6bba1a39b3c5818f3d4e1e3352a58526261be9342453808f0423b426@group.calendar.google.com";

        // --- Library Data ---
        const presetActivities = [
            // NEUTRAL / OFFENSE
            { id: 'n1', title: 'Duck Walk', duration: 5, category: 'Neutral / Offense' },
            { id: 'n2', title: 'Penetration Drills', duration: 10, description: 'Double or High Crotch', category: 'Neutral / Offense' },
            { id: 'n3', title: 'Stagger Stance/Motion', duration: 5, description: 'Head, elbow, feet', category: 'Neutral / Offense' },
            { id: 'n4', title: 'Snap Down / Head Draw', duration: 5, category: 'Neutral / Offense' },
            { id: 'n5', title: 'Single Leg Treetops', duration: 5, category: 'Neutral / Offense' },
            { id: 'n6', title: 'Single Leg Run Pipes', duration: 5, category: 'Neutral / Offense' },
            { id: 'n7', title: 'Post-n-Run', duration: 5, description: 'Creating angles from mat', category: 'Neutral / Offense' },
            { id: 'n8', title: 'High Crotch (Variations)', duration: 10, description: 'Elbow tie, underhooks, inside/outside', category: 'Neutral / Offense' },
            { id: 'n9', title: 'Double Leg (Lifts/Chops)', duration: 10, description: 'Kneechop, lift, turks, get to corner', category: 'Neutral / Offense' },
            { id: 'n10', title: 'Firemans / Dump / Tip', duration: 5, category: 'Neutral / Offense' },
            { id: 'n11', title: 'Throws', duration: 10, description: 'Head & arm, Hip toss, Back step', category: 'Neutral / Offense' },
            { id: 'n12', title: 'Randy Lewis Elbow Block', duration: 5, category: 'Neutral / Offense' },
            { id: 'n13', title: 'Situation Drills (Live)', duration: 15, description: 'In on a double/single', category: 'Neutral / Offense' },
            { id: 'n14', title: 'IRONMAN', duration: 8, description: 'Neutral intensity', category: 'Neutral / Offense' },
            { id: 'n15', title: 'Offensive Attack Series', duration: 10, description: 'Setups to Shot to Finish', category: 'Neutral / Offense' },
            { id: 'n16', title: 'Chain Wrestling (Offense)', duration: 10, description: 'Shot 1 -> Shot 2 -> Shot 3', category: 'Neutral / Offense' },
            // K-JAYS NEUTRAL ADDITIONS
            { id: 'n17', title: 'Leap Frog Shot', duration: 2, category: 'Neutral / Offense', description: 'K-Jays Essential' },
            { id: 'n18', title: 'Sprawl Push Aways', duration: 2, category: 'Neutral / Offense', description: 'K-Jays Essential' },
            { id: 'n19', title: 'Chest Spin', duration: 2, category: 'Neutral / Offense', description: 'K-Jays Essential' },
            { id: 'n20', title: 'Ankle Tag', duration: 10, category: 'Neutral / Offense', description: 'Snap if too low for ankle' },
            { id: 'n21', title: 'Sprawl Front Headlock', duration: 10, category: 'Neutral / Offense', description: 'Circle Circle chase ankles' },
            { id: 'n22', title: 'Circle Circle Chase Ankles', duration: 5, category: 'Neutral / Offense' },

            // TOP
            { id: 't1', title: 'Spiral Ride', duration: 5, description: 'Halfs, bar arms, hooks', category: 'Top' },
            { id: 't2', title: 'Leg Riding', duration: 10, description: 'Extend opponent', category: 'Top' },
            { id: 't3', title: 'Reinhardt / Crab Ride', duration: 5, category: 'Top' },
            { id: 't4', title: 'Ankle Breakdowns', duration: 5, category: 'Top' },
            { id: 't5', title: 'Cradles', duration: 10, description: 'Near, far, cross cradle', category: 'Top' },
            { id: 't6', title: 'Half Nelson / Power Half', duration: 5, category: 'Top' },
            { id: 't7', title: 'Bar Arm / Pete Bar', duration: 5, category: 'Top' },
            { id: 't8', title: 'Coffee Grinder / Guillotine', duration: 5, category: 'Top' },
            { id: 't9', title: 'Bundle', duration: 5, category: 'Top' },
            // K-JAYS TOP ADDITIONS
            { id: 't10', title: 'Mat Return', duration: 10, category: 'Top', description: 'Break Table Ankle' },
            { id: 't11', title: 'Break Table', duration: 10, category: 'Top', description: 'Pick, Far Far' },
            { id: 't12', title: 'Keep Flat', duration: 10, category: 'Top', description: 'Blanket use head and toes' },
            { id: 't13', title: 'Run Wrists', duration: 5, category: 'Top' },
            { id: 't14', title: 'Triangle Series', duration: 10, category: 'Top' },

            // BOTTOM
            { id: 'b1', title: 'Build Base', duration: 5, description: 'Thumbs up, elbows in, head up', category: 'Bottom' },
            { id: 'b2', title: 'Stand Ups', duration: 5, description: 'Switches, 1/4 turns', category: 'Bottom' },
            { id: 'b3', title: 'Sit Out / Popcorn', duration: 5, category: 'Bottom' },
            { id: 'b4', title: 'Hip Heist', duration: 5, category: 'Bottom' },
            { id: 'b5', title: 'Switch', duration: 5, description: 'Standing, lift-switch', category: 'Bottom' },
            { id: 'b6', title: 'Rolls', duration: 5, description: 'Granby, Peterson, Near/Far side', category: 'Bottom' },
            // K-JAYS BOTTOM ADDITIONS
            { id: 'b7', title: 'Diamond Build Ups', duration: 2, category: 'Bottom', description: 'K-Jays Essential' },
            { id: 'b8', title: 'Short Sit Crab to Bear Knee Jam', duration: 2, category: 'Bottom', description: 'K-Jays Essential' },
            { id: 'b9', title: 'Quadpod Knee Jam', duration: 10, category: 'Bottom' },
            { id: 'b10', title: 'Movement Hand Control', duration: 10, category: 'Bottom', description: 'Change over, quad, sit, heist' },
            { id: 'b11', title: 'Stuff Head / Push Knees', duration: 10, category: 'Bottom', description: 'Sprawl Double/Single' },

            // CONDITIONING
            { id: 'c1', title: 'Sprints', duration: 20, category: 'Conditioning' },
            { id: 'c2', title: 'Ropes / Chair Dips', duration: 10, category: 'Conditioning' },
            { id: 'c3', title: 'Run & Lift', duration: 15, description: 'Work till they drop', category: 'Conditioning' },
            { id: 'c4', title: 'Games', duration: 10, category: 'Conditioning' },
            // K-JAYS NINJA TRAINING / ESSENTIALS
            { id: 'c5', title: 'Bridge Circles', duration: 2, category: 'Conditioning', description: 'K-Jays Essential' },
            { id: 'c6', title: 'Forward Rolls', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c7', title: 'Backwards Rolls', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c8', title: 'Cart Wheels', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c9', title: 'Lateral Glides', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c10', title: 'Bear Crawl', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c11', title: 'Gorilla Walk', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c12', title: 'Head Springs', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c13', title: 'One Leg Hop', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c14', title: 'Knee to Feet Explosions', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c15', title: 'High Knees', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c16', title: 'Butt Kickers', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c17', title: 'Forward Skip', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c18', title: 'Standing Broad Jump', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c19', title: 'Bunny Hops', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c20', title: 'Backwards Sprint', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c21', title: 'Crab Walk', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c22', title: 'Knee Running', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c23', title: 'Sideways Plank Walk', duration: 2, category: 'Conditioning', description: 'Ninja Training' },
            { id: 'c24', title: 'Seal Crawl', duration: 2, category: 'Conditioning', description: 'Ninja Training' },

            // COOL DOWN
            { id: 'cd1', title: 'Partner Static Stretching', duration: 5, description: 'Post-match recovery', category: 'Cool Down' },
            { id: 'cd2', title: 'Dynamic Mobility Flow', duration: 5, description: 'Hip and shoulder openers', category: 'Cool Down' },
            { id: 'cd3', title: 'Shadow Wrestling (Light)', duration: 3, description: 'Perfect form, low intensity', category: 'Cool Down' },
            { id: 'cd4', title: 'Foam Rolling / SMR', duration: 5, description: 'Focus on legs and back', category: 'Cool Down' },
            { id: 'cd5', title: 'Mental Review / Breathing', duration: 2, description: 'Recovery focus', category: 'Cool Down' },

            // SPECIALS
            { id: 's1', title: 'Jonny Jones', duration: 5, category: 'Specials' },
            { id: 's2', title: 'Talvi – 1/4', duration: 5, category: 'Specials' },
            { id: 's3', title: 'Vania – Post', duration: 5, category: 'Specials' },
            
            // K-JAYS SPECIAL BLOCKS (For easy schedule building)
            { id: 'k_ess', title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials', description: 'Leap Frog, Diamond, Crab, Sprawl, Bridge, Spin' },
            { id: 'k_nin', title: 'Ninja Training Circuit', duration: 10, category: 'Specials', description: 'Agility & Tumbling Series' },
            { id: 'k_fin', title: 'Finish Talk', duration: 5, category: 'Specials', description: 'What was fun tonight?' },
            { id: 'k_cln', title: 'Clean Up', duration: 5, category: 'Specials', description: 'Mat Hygiene' }
        ];

        // --- State Management ---
        let state = {
            mode: 'setup', 
            setupStep: 'details', 
            currentPlanId: null, // TRACK FIRESTORE DOC ID
            practiceName: '',    // OPTIONAL NAME
            practiceDate: new Date().toISOString().split('T')[0],
            startTime: '15:30',
            endTime: '17:00',
            activities: [], 
            customActivities: [], 
            selectedPresets: {}, 
            options: { enableWhistle: true, enableVoice: true, autoRestSeconds: 0 },
            currentActivityIndex: 0,
            isRunning: false,
            elapsedSeconds: 0,
            intervalId: null,
            currentTime: '',
            editingId: null,
            showCustomForm: false,
            stationEditId: null,
            showSplitSelector: false,
            tempRotationCount: 1, 
            liveInterval: 0, // NEW: 0=Off, 15, 30, 60
            history: [],
            showHistory: false,
            isLoadingHistory: false,
            showLoginModal: false,
            showAccountModal: false,
            pendingAction: null, 
            authEmail: '',
            authPass: '',
            authIsRegister: false,
            authError: '',
            authLoading: false
        };

        const STORAGE_KEY = 'wrestling-system-v5'; // Custom library
        const SESSION_KEY = 'wrestling-active-session-v2'; // Active session persistence

        // --- GLOBAL VARIABLES FOR FIXES ---
        let audioCtx = null;
        let wakeLock = null;

        // --- PERSISTENCE LOGIC ---
        function saveActiveSession() {
            // Create a safe copy of state to save (excluding non-serializable stuff)
            const stateToSave = {
                ...state,
                intervalId: null, // Don't save the timer ID
                isRunning: false, // Always save as paused so it doesn't auto-start on reload
                showLoginModal: false, // Don't reopen modals automatically
                showAccountModal: false
            };
            localStorage.setItem(SESSION_KEY, JSON.stringify(stateToSave));
        }

        function clearActiveSession() {
            localStorage.removeItem(SESSION_KEY);
        }

        function restoreActiveSession() {
            const saved = localStorage.getItem(SESSION_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Merge saved state
                    state = { ...state, ...parsed };
                    
                    // Ensure timer is stopped
                    state.intervalId = null;
                    state.isRunning = false;
                    
                    console.log("Session restored from local storage");
                    render();
                } catch(e) {
                    console.error("Error restoring session", e);
                }
            }
        }

        // --- AUTH & EVENT HANDLING ---
        window.addEventListener('auth-change', () => {
            if (window.currentUser) {
                state.showLoginModal = false;
                fetchLibraryFromCloud();

                if (state.pendingAction === 'history') {
                    state.pendingAction = null;
                    state.showAccountModal = true; 
                    render();
                } else if (state.pendingAction === 'save') {
                    state.pendingAction = null;
                    savePracticePlan(); 
                } else if (state.pendingAction === 'syncLib') {
                    state.pendingAction = null;
                    syncLibraryToCloud();
                } else {
                    render(); 
                }
            } else {
                render();
            }
        });

        // --- Utilities ---
        
        // FIX 2: Wake Lock API
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen Wake Lock active');
                } catch (err) {
                    console.error(`Wake Lock Error: ${err.name}, ${err.message}`);
                }
            }
        }

        // FIX 3: Global Audio Context Init
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playWhistle() {
            if (!state.options.enableWhistle) return;
            initAudio(); // Ensure context is ready/resumed
            try {
                // Use global audioCtx
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.type = 'square'; osc.frequency.setValueAtTime(900, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1300, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
                osc.start(); osc.stop(audioCtx.currentTime + 0.4);
            } catch (e) {
                console.error("Whistle error", e);
            }
        }

        function speak(text) {
            if (!state.options.enableVoice) return;
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text);
            msg.rate = 1;
            window.speechSynthesis.speak(msg);
        }

        function showMessage(message, type = 'info') {
            const box = document.getElementById('message-box');
            let color = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-blue-600');
            box.innerHTML = `<div class="${color} text-white p-4 rounded-xl shadow-2xl font-bold border-2 border-white/20">${message}</div>`;
            box.classList.remove('translate-x-full');
            box.classList.add('translate-x-0');
            setTimeout(() => { box.classList.remove('translate-x-0'); box.classList.add('translate-x-full'); }, 3000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function getTotalDuration() { return state.activities.reduce((sum, a) => sum + a.duration, 0); }

        function getProgressPercentage() {
            if (!state.activities.length) return 0;
            const totalSecs = getTotalDuration() * 60;
            const doneSecs = state.activities.slice(0, state.currentActivityIndex).reduce((sum, a) => sum + a.duration * 60, 0) + state.elapsedSeconds;
            return Math.min((doneSecs / totalSecs) * 100, 100);
        }

        // --- Logic ---
        async function startPractice() {
            initAudio(); // Fix 3: Init Audio on interaction
            requestWakeLock(); // Fix 2: Keep screen awake
            savePracticePlan(false); // Autosave (silent)
            state.mode = 'live';
            state.currentActivityIndex = 0;
            state.elapsedSeconds = 0;
            render(); // Trigger save via render
            startTimer();
        }

        function exitSession() {
            if(!confirm("Are you sure you want to exit? Current progress will be lost. (Unless you saved the plan)")) return;
            pauseTimer();
            state.mode = 'setup';
            state.activities = [];
            state.currentActivityIndex = 0;
            state.elapsedSeconds = 0;
            state.practiceName = '';
            state.currentPlanId = null;
            state.liveInterval = 0; // Reset interval
            clearActiveSession(); // Clear storage on explicit exit
            
            // Release wake lock if it exists
            if(wakeLock) {
                wakeLock.release().then(() => { wakeLock = null; });
            }
            
            render();
        }

        // UPDATED SAVE FUNCTION: Handles Upsert (Update or Insert)
        async function savePracticePlan(showAlert = true) {
            if (!window.currentUser) {
                if (showAlert) {
                    state.pendingAction = 'save';
                    state.showLoginModal = true;
                    render();
                }
                return;
            }

            if (window.currentUser && window.db) {
                const btn = document.getElementById('save-plan-btn');
                if(btn && showAlert) { btn.innerText = "Saving..."; btn.disabled = true; }
                
                try {
                    const path = window.collection(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "practice_plans");
                    
                    const planData = {
                        name: state.practiceName,
                        date: state.practiceDate,
                        startTime: state.startTime,
                        endTime: state.endTime,
                        activities: state.activities,
                        totalDuration: getTotalDuration(),
                        timestamp: window.serverTimestamp(),
                    };

                    if (state.currentPlanId) {
                        // UPDATE EXISTING
                        const docRef = window.doc(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "practice_plans", state.currentPlanId);
                        await window.setDoc(docRef, { ...planData, updatedAt: new Date().toISOString() }, { merge: true });
                        if (showAlert) showMessage('Practice Plan Updated!', 'success');
                    } else {
                        // CREATE NEW
                        planData.createdAt = new Date().toISOString();
                        const docRef = await window.addDoc(path, planData);
                        state.currentPlanId = docRef.id; // Store ID to prevent duplicates on next save
                        if (showAlert) showMessage('Practice Plan Saved!', 'success');
                    }

                    if (!showAlert) console.log('Autosaved plan.');
                } catch (err) {
                    console.error("Firebase Save Error", err);
                    if (showAlert) showMessage('Save Failed', 'error');
                } finally {
                    if(btn && showAlert) { btn.innerHTML = 'Save Plan'; btn.disabled = false; }
                }
            }
        }

        async function syncLibraryToCloud() {
            if (!window.currentUser) {
                state.pendingAction = 'syncLib';
                state.showLoginModal = true;
                render();
                return;
            }

            const btn = document.getElementById('sync-btn');
            if(btn) { btn.innerText = "Syncing..."; btn.disabled = true; }

            try {
                const batch = window.writeBatch(window.db);
                const allDrills = [...presetActivities, ...state.customActivities];
                
                allDrills.forEach(drill => {
                    const docRef = window.doc(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "drill_library", drill.id);
                    batch.set(docRef, drill, { merge: true });
                });

                await batch.commit();
                showMessage('Library synced to cloud successfully!', 'success');
            } catch (e) {
                console.error(e);
                showMessage('Sync failed: ' + e.message, 'error');
            } finally {
                if(btn) { btn.innerText = "Sync to Cloud"; btn.disabled = false; }
            }
        }

        async function addCustomDrill() {
            const t = document.getElementById('c-title').value;
            const d = parseInt(document.getElementById('c-dur').value) || 5;
            const c = document.getElementById('c-cat').value;
            if (t) {
                const newDrill = { id: 'c'+Date.now(), title: t, duration: d, category: c };
                state.customActivities.push(newDrill);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.customActivities));
                
                if (window.currentUser) {
                    try {
                        const docRef = window.doc(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "drill_library", newDrill.id);
                        await window.setDoc(docRef, newDrill);
                        showMessage('Saved to Cloud Library', 'success');
                    } catch(e) {
                        console.error("Cloud save error", e);
                        showMessage('Saved locally. Cloud error.', 'error');
                    }
                }

                state.showCustomForm = false; 
                render();
            }
        }

        async function fetchLibraryFromCloud() {
            if (!window.currentUser) return;
            try {
                const libRef = window.collection(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "drill_library");
                const snap = await window.getDocs(libRef);
                if (!snap.empty) {
                    const remoteDrills = [];
                    snap.forEach(doc => remoteDrills.push(doc.data()));
                    state.customActivities = remoteDrills;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.customActivities));
                    render();
                    console.log("Drill library synced from cloud");
                }
            } catch (e) {
                console.error("Fetch library failed", e);
            }
        }

        async function pushPresetsToCloud() {
            if (!window.currentUser) {
                showMessage("Login required to sync presets", "error");
                return;
            }
            if(!confirm("This will add all default system drills to your cloud library. Continue?")) return;

            const btn = document.getElementById('push-presets-btn');
            if(btn) { btn.innerText = "Pushing..."; btn.disabled = true; }

            try {
                const batch = window.writeBatch(window.db);
                let count = 0;
                presetActivities.forEach(drill => {
                    const docRef = window.doc(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "drill_library", drill.id);
                    batch.set(docRef, drill);
                    count++;
                });
                await batch.commit();
                showMessage(`${count} presets added to cloud!`, 'success');
                fetchLibraryFromCloud(); 
            } catch (e) {
                console.error("Batch push error", e);
                showMessage("Sync failed: " + e.message, "error");
            } finally {
                if(btn) { btn.innerText = "Push Presets to Cloud"; btn.disabled = false; }
            }
        }

        function handleHistoryClick() {
            if (!window.currentUser) {
                state.pendingAction = 'history';
                state.showLoginModal = true;
            } else {
                state.showAccountModal = true; 
            }
            render();
        }

        async function confirmAccountAndFetch() {
            state.showAccountModal = false;
            if(!window.getDocs) {
                showMessage("Database initializing...", "info");
                setTimeout(fetchHistoryActual, 1000);
                return;
            }
            fetchHistoryActual();
        }

        async function fetchHistoryActual() {
            state.showHistory = true; 
            state.isLoadingHistory = true;
            render(); 
            
            try {
                const path = window.collection(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "practice_plans");
                const snapshot = await window.getDocs(path);
                const plans = [];
                snapshot.forEach(doc => plans.push({ id: doc.id, ...doc.data() }));
                plans.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                state.history = plans;
            } catch (e) {
                console.error(e);
                showMessage('Failed to load history: ' + e.message, 'error');
            } finally {
                state.isLoadingHistory = false;
                render();
            }
        }

        function loadHistoryItem(id) {
            const plan = state.history.find(p => p.id === id);
            if (plan) {
                state.activities = plan.activities || [];
                state.practiceName = plan.name || ''; // Load name
                
                // FIX 1: Prevent History Overwrite
                state.practiceDate = new Date().toISOString().split('T')[0]; // Reset date to today
                state.currentPlanId = null; // Clear ID so it saves as new
                
                state.setupStep = 'schedule';
                state.showHistory = false;
                showMessage('Plan loaded as template! (Saved as new)', 'success');
                render();
            }
        }

        async function deleteHistoryItem(id) {
            if (!confirm('Are you sure you want to delete this plan?')) return;
            try {
                const docRef = window.doc(window.db, "artifacts", window.appId, "users", window.currentUser.uid, "practice_plans", id);
                await window.deleteDoc(docRef);
                state.history = state.history.filter(h => h.id !== id);
                render();
                showMessage('Plan deleted', 'success');
            } catch(e) {
                console.error(e);
                showMessage('Delete failed', 'error');
            }
        }

        async function handleLoginSubmit(e) {
            e.preventDefault();
            state.authLoading = true;
            state.authError = '';
            render(); 

            const result = await window.performEmailLogin(state.authEmail, state.authPass, state.authIsRegister);
            
            state.authLoading = false;
            if (!result.success) {
                state.authError = result.error;
            } else {
                state.showLoginModal = false;
            }
            render();
        }

        async function uploadToCalendar() {
            const btn = document.getElementById('cal-upload-btn');
            if(btn) { btn.innerText = "Uploading..."; btn.disabled = true; }
            
            const description = `FOCUS: Wrestling Practice\n\nAGENDA:\n` + 
                state.activities.map((item, i) => {
                    let noteText = item.notes ? ` (Note: ${item.notes})` : '';
                    if (item.type === 'station') return `- [${item.duration}m] STATION ROTATION${noteText}`;
                    return `- [${item.duration}m] ${item.title.toUpperCase()} (${item.category})${noteText}`;
                }).join('\n');

            const startDateTime = new Date(`${state.practiceDate}T${state.startTime}`).toISOString();
            const endDateTime = new Date(`${state.practiceDate}T${state.endTime}`).toISOString();

            const payload = {
                calendarId: GOOGLE_CALENDAR_ID,
                event: {
                    title: `Wrestling Practice`,
                    location: "Wrestling Room",
                    description: description,
                    startTime: startDateTime,
                    endTime: endDateTime
                }
            };

            try {
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
                showMessage('Uploaded to Team Calendar!', 'success');
            } catch (error) {
                console.error("Upload failed", error);
                showMessage('Failed to upload. Check console.', 'error');
            } finally {
                if(btn) { btn.innerHTML = 'UPLOAD TO CALENDAR'; btn.disabled = false; }
            }
        }

        function adjustLiveTime(minutes) {
            if (!state.activities[state.currentActivityIndex]) return;
            const act = state.activities[state.currentActivityIndex];
            
            const newDuration = Math.max(1, act.duration + minutes);
            // Safety check: Don't reduce time below elapsed time
            if (newDuration * 60 < state.elapsedSeconds) {
                showMessage("Cannot reduce time below current elapsed!", "error");
                return;
            }
            
            act.duration = newDuration;
            saveActiveSession(); // Save changes
            render();
        }

        function startTimer() {
            if (state.intervalId) return;
            const cur = state.activities[state.currentActivityIndex];
            if (state.elapsedSeconds === 0 && cur) {
                const title = cur.type === 'station' ? 'Rotation Starting' : `Starting ${cur.title}`;
                speak(title); playWhistle();
            }
            state.isRunning = true;
            state.intervalId = setInterval(() => {
                state.elapsedSeconds++;
                
                // --- INTERVAL WHISTLE (SHARK BAIT) ---
                if (state.liveInterval > 0 && state.elapsedSeconds > 0 && state.elapsedSeconds % state.liveInterval === 0) {
                    playWhistle();
                }

                // --- SAVE PROGRESS EVERY 5 SECONDS ---
                if (state.elapsedSeconds % 5 === 0) {
                    saveActiveSession();
                }

                const cur = state.activities[state.currentActivityIndex];
                if (cur && state.elapsedSeconds >= cur.duration * 60) {
                    playWhistle();
                    if (state.currentActivityIndex < state.activities.length - 1) {
                        state.currentActivityIndex++;
                        state.elapsedSeconds = 0;
                        const next = state.activities[state.currentActivityIndex];
                        speak(next.type === 'station' ? "Next up: Station Rotations" : `Next up: ${next.title}`);
                    } else {
                        pauseTimer();
                        state.currentActivityIndex = state.activities.length;
                        speak("Practice complete. Champions are made today.");
                    }
                }
                render();
            }, 1000);
        }

        function pauseTimer() {
            if (state.intervalId) clearInterval(state.intervalId);
            state.isRunning = false;
            state.intervalId = null;
            render(); // will save session
        }

        function duplicateDrill(idx) {
            const original = state.activities[idx];
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = 'copy' + Math.random(); 
            state.activities.splice(idx + 1, 0, copy);
            render();
        }

        function updateDrillDuration(idx, change) {
            const newDur = state.activities[idx].duration + change;
            if (newDur >= 1) {
                state.activities[idx].duration = newDur;
                render(); 
            }
        }

        function updateDrillNote(idx, note) {
            state.activities[idx].notes = note;
            saveActiveSession(); // Save text input changes immediately might be too much? No, it's fine.
        }

        function generatePrintPlan() {
            const printArea = document.getElementById('print-area');
            let html = `
                <div class="print-header">
                    <h1 style="font-size: 28px; font-weight: 900; text-transform: uppercase; margin: 0;">${state.practiceName || 'Wrestling Practice Plan'}</h1>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-weight: bold;">
                        <span>Date: ${state.practiceDate || 'N/A'}</span>
                        <span>Time: ${state.startTime} - ${state.endTime}</span>
                        <span>Total: ${getTotalDuration()} min</span>
                    </div>
                </div>
                <div>
            `;

            state.activities.forEach((a, i) => {
                html += `
                    <div class="print-card">
                        <div style="display: flex; justify-content: space-between; font-weight: 900; font-size: 16px;">
                            <span>${i + 1}. ${a.type === 'station' ? 'GROUP SPLIT ROTATION' : a.title.toUpperCase()}</span>
                            <span>${a.duration} min</span>
                        </div>
                        <div style="font-size: 11px; text-transform: uppercase; color: #666; margin-bottom: 5px;">Category: ${a.category || (a.type === 'station' ? 'Station' : 'Drill')}</div>
                        ${a.description ? `<div style="font-size: 13px; margin-top: 5px;">${a.description}</div>` : ''}
                        ${a.notes ? `<div style="font-size: 13px; margin-top: 5px; font-weight: bold; color: #444;">NOTE: ${a.notes}</div>` : ''}
                        
                        ${a.type === 'station' ? `
                            <div class="print-station-grid">
                                ${a.groups.map((g, gi) => `
                                    <div class="print-station-box">
                                        <div style="font-weight: bold; border-bottom: 1px solid #ddd; margin-bottom: 4px;">GROUP ${String.fromCharCode(65+gi)}</div>
                                        <div style="font-weight: 900;">${g.title}</div>
                                        <div style="font-size: 10px; color: #555;">${g.description || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += `
                </div>
                <div style="margin-top: 30px; font-style: italic; font-size: 12px; text-align: center; border-top: 1px dashed #ccc; padding-top: 10px;">
                    Champions are made in the practice room.
                </div>
            `;

            printArea.innerHTML = html;
            window.print();
        }

        // --- Render Logic ---
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = state.mode === 'setup' ? renderSetup() : renderLive();
            
            // Auto-save on every render unless running (saved in timer)
            if (state.mode !== 'live' || !state.isRunning) {
                saveActiveSession();
            }
        }

        function renderLoginModal() {
            return `
                <div class="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div class="bg-gray-800 rounded-3xl border-2 border-pink-500 w-full max-w-md p-8 text-center shadow-2xl relative">
                        <button onclick="state.showLoginModal=false;render();" class="absolute top-4 right-4 text-gray-500 hover:text-white">✕</button>
                        
                        <div class="text-center mb-6">
                            <h3 class="text-2xl font-black uppercase italic text-white mb-2">Team Access</h3>
                            <p class="text-gray-400 text-xs">Save plans and track history</p>
                        </div>

                        <form onsubmit="handleLoginSubmit(event)" class="space-y-4 text-left">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                                <input required type="email" value="${state.authEmail}" oninput="state.authEmail=this.value" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-pink-500 outline-none" placeholder="coach@example.com">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                                <input required type="password" value="${state.authPass}" oninput="state.authPass=this.value" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-pink-500 outline-none" placeholder="••••••">
                            </div>

                            ${state.authError ? `<div class="text-red-400 text-xs p-2 bg-red-900/20 rounded text-center">${state.authError}</div>` : ''}

                            <button type="submit" ${state.authLoading ? 'disabled' : ''} class="w-full py-4 bg-pink-600 hover:bg-pink-500 rounded-xl font-black uppercase text-white shadow-lg transition-all disabled:opacity-50">
                                ${state.authLoading ? 'Processing...' : (state.authIsRegister ? 'Create Account' : 'Sign In')}
                            </button>
                        </form>

                        <div class="mt-6 text-xs text-gray-500">
                            <button onclick="state.authIsRegister=!state.authIsRegister;state.authError='';render();" class="text-pink-400 hover:text-white font-bold underline">
                                ${state.authIsRegister ? 'Have an account? Sign In' : 'Need an account? Sign Up'}
                            </button>
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-700">
                            <button onclick="state.showLoginModal=false;render();" class="text-gray-500 hover:text-white uppercase text-[10px] font-bold tracking-widest">
                                Continue Offline
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAccountModal() {
            const uid = window.currentUser ? window.currentUser.uid.substring(0, 8) + '...' : 'Unknown';
            const email = window.currentUser ? window.currentUser.email : 'No Email';
            return `
                <div class="fixed inset-0 z-[130] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div class="bg-gray-800 rounded-3xl border-2 border-green-500 w-full max-w-md p-8 text-center shadow-2xl">
                        <h3 class="text-2xl font-black uppercase italic text-green-400 mb-2">Account Verified</h3>
                        <div class="bg-gray-900 p-4 rounded-xl border border-white/10 mb-6">
                            <div class="text-xs uppercase text-gray-500 font-bold mb-1">Logged In As</div>
                            <div class="font-bold text-white text-lg mb-1">${email}</div>
                            <div class="font-mono text-xs text-gray-600">ID: ${uid}</div>
                            <div class="text-[10px] text-green-500 uppercase font-bold mt-2">● Connected Securely</div>
                        </div>
                        <p class="text-gray-400 text-sm mb-8">Load your practice history?</p>
                        
                        <button onclick="confirmAccountAndFetch()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded-xl font-black uppercase text-white shadow-lg transition-all mb-4">
                            Confirm & Load History
                        </button>
                        <button onclick="state.showAccountModal=false;render();" class="text-gray-500 hover:text-white uppercase text-xs font-bold tracking-widest">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSetup() {
            let content = '';
            if (state.setupStep === 'details') content = renderDetails();
            else if (state.setupStep === 'activities') content = renderLibrary();
            else if (state.setupStep === 'schedule') content = renderSchedule();

            const steps = [{id:'details',n:'Basic Info'},{id:'activities',n:'Drill Library'},{id:'schedule',n:'Final Schedule'}];

            return `
                <div class="flex-1 bg-gradient-to-br from-blue-950 via-gray-900 to-black overflow-y-auto custom-scrollbar flex flex-col">
                    <header class="bg-blue-900 border-b-4 border-yellow-500 py-6 text-center shrink-0">
                        <h1 class="text-4xl font-black text-yellow-400 italic uppercase">Wrestling Practice System</h1>
                    </header>
                    <nav class="bg-gray-800 border-b border-white/10 sticky top-0 z-50 p-2 flex gap-2 shrink-0">
                        ${steps.map((s, i) => `
                            <button onclick="state.setupStep='${s.id}';render();" class="flex-1 py-3 rounded-xl font-bold uppercase text-xs tracking-widest transition-all ${state.setupStep === s.id ? 'bg-blue-600 ring-2 ring-yellow-400 text-white' : 'text-gray-500 hover:bg-gray-700'}">
                                ${i + 1}. ${s.n}
                            </button>
                        `).join('')}
                    </nav>
                    <main class="max-w-7xl mx-auto p-4 md:p-8 w-full flex-1">${content}</main>
                </div>
                ${state.showHistory ? renderHistoryModal() : ''}
                ${state.showLoginModal ? renderLoginModal() : ''}
                ${state.showAccountModal ? renderAccountModal() : ''}
            `;
        }

        function renderDetails() {
            return `
                <div class="space-y-8">
                    <!-- Top Row: Session Info and Automation Settings -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-800 p-8 rounded-3xl border-2 border-blue-500 shadow-xl space-y-6">
                            <h2 class="text-2xl font-black uppercase text-blue-400">Session Info</h2>
                            <div class="space-y-4">
                                <label class="block"><span class="text-xs font-bold uppercase opacity-50">Practice Name (Optional)</span><input oninput="state.practiceName=this.value" type="text" value="${state.practiceName}" placeholder="e.g. Pre-Regionals Hard Day" class="w-full bg-gray-900 border-2 border-gray-700 rounded-xl p-4 mt-1 focus:border-blue-500 outline-none transition-all placeholder-gray-600" /></label>
                                <label class="block"><span class="text-xs font-bold uppercase opacity-50">Date</span><input oninput="state.practiceDate=this.value" type="date" value="${state.practiceDate}" class="w-full bg-gray-900 border-2 border-gray-700 rounded-xl p-4 mt-1 focus:border-blue-500 outline-none transition-all" /></label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="block"><span class="text-xs font-bold uppercase opacity-50">Start</span><input oninput="state.startTime=this.value" type="time" value="${state.startTime}" class="w-full bg-gray-900 border-2 border-gray-700 rounded-xl p-4 mt-1 outline-none" /></label>
                                    <label class="block"><span class="text-xs font-bold uppercase opacity-50">End</span><input oninput="state.endTime=this.value" type="time" value="${state.endTime}" class="w-full bg-gray-900 border-2 border-gray-700 rounded-xl p-4 mt-1 outline-none" /></label>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-800 p-8 rounded-3xl border-2 border-yellow-500 shadow-xl space-y-6">
                            <h2 class="text-2xl font-black uppercase text-yellow-400">Settings</h2>
                            <div class="space-y-4">
                                <button onclick="state.options.enableWhistle=!state.options.enableWhistle;render();" class="w-full flex items-center justify-between p-4 bg-gray-900 rounded-xl border border-white/5">
                                    <div class="text-left"><div class="font-bold">Whistle Sounds</div><div class="text-xs opacity-50">Starts/Ends intervals</div></div>
                                    <div class="w-12 h-6 rounded-full ${state.options.enableWhistle ? 'bg-blue-600' : 'bg-gray-700'} relative transition-colors"><div class="absolute w-4 h-4 bg-white rounded-full top-1 transition-all ${state.options.enableWhistle ? 'left-7' : 'left-1'}"></div></div>
                                </button>
                                <button onclick="state.options.enableVoice=!state.options.enableVoice;render();" class="w-full flex items-center justify-between p-4 bg-gray-900 rounded-xl border border-white/5">
                                    <div class="text-left"><div class="font-bold">Voice Guide</div><div class="text-xs opacity-50">Announce moves</div></div>
                                    <div class="w-12 h-6 rounded-full ${state.options.enableVoice ? 'bg-blue-600' : 'bg-gray-700'} relative transition-colors"><div class="absolute w-4 h-4 bg-white rounded-full top-1 transition-all ${state.options.enableVoice ? 'left-7' : 'left-1'}"></div></div>
                                </button>
                                <div class="p-4 bg-gray-900 rounded-xl">
                                    <span class="text-xs font-bold uppercase opacity-50">Auto-Rest Between Drills</span>
                                    <select onchange="state.options.autoRestSeconds=parseInt(this.value)" class="w-full bg-gray-900 p-2 outline-none border border-gray-700 rounded-lg text-white mt-1">
                                        <option value="0" class="bg-gray-900">No rest</option>
                                        <option value="30" class="bg-gray-900">30 Seconds</option>
                                        <option value="60" class="bg-gray-900">1 Minute</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- K-JAYS YOUTH SECTION -->
                    <div class="bg-gray-800 p-8 rounded-3xl border-2 border-green-500 shadow-xl">
                        <h2 class="text-2xl font-black uppercase text-green-400 italic mb-6">K-Jays Youth Program</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                             <button onclick="loadTemplate('kjays-essentials')" class="p-4 bg-gray-900 rounded-xl border border-green-500/20 hover:border-green-500 hover:bg-green-900/20 transition-all text-center group">
                                <div class="text-green-400 font-black mb-1 text-sm group-hover:scale-105 transition-transform">6 ESSENTIALS</div>
                                <div class="text-[9px] opacity-50 uppercase font-bold">2min Each</div>
                            </button>
                             <button onclick="loadTemplate('kjays-ninja')" class="p-4 bg-gray-900 rounded-xl border border-green-500/20 hover:border-green-500 hover:bg-green-900/20 transition-all text-center group">
                                <div class="text-green-400 font-black mb-1 text-sm group-hover:scale-105 transition-transform">NINJA TRAINING</div>
                                <div class="text-[9px] opacity-50 uppercase font-bold">Agility Series</div>
                            </button>
                            <button onclick="loadTemplate('kjays-day3')" class="p-4 bg-gray-900 rounded-xl border border-white/10 hover:border-white hover:bg-white/5 transition-all text-center">
                                <div class="text-white font-black mb-1 text-lg">DAY 3</div>
                                <div class="text-[9px] opacity-50 uppercase font-bold">Full Schedule</div>
                            </button>
                            <button onclick="loadTemplate('kjays-day4')" class="p-4 bg-gray-900 rounded-xl border border-white/10 hover:border-white hover:bg-white/5 transition-all text-center">
                                <div class="text-white font-black mb-1 text-lg">DAY 4</div>
                                <div class="text-[9px] opacity-50 uppercase font-bold">Full Schedule</div>
                            </button>
                            <button onclick="loadTemplate('kjays-day5')" class="p-4 bg-gray-900 rounded-xl border border-white/10 hover:border-white hover:bg-white/5 transition-all text-center">
                                <div class="text-white font-black mb-1 text-lg">DAY 5</div>
                                <div class="text-[9px] opacity-50 uppercase font-bold">Full Schedule</div>
                            </button>
                             <button onclick="loadTemplate('kjays-day6')" class="p-4 bg-gray-900 rounded-xl border border-white/10 hover:border-white hover:bg-white/5 transition-all text-center">
                                <div class="text-white font-black mb-1 text-lg">DAY 6</div>
                                <div class="text-[9px] opacity-50 uppercase font-bold">Full Schedule</div>
                            </button>
                        </div>
                    </div>

                    <!-- Bottom Row: Session Type Options -->
                    <div class="bg-gray-800 p-8 rounded-3xl border-2 border-white/10 shadow-xl">
                        <h2 class="text-2xl font-black uppercase text-white italic mb-6">Standard Templates</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <button onclick="state.activities=[];state.currentPlanId=null;state.practiceName='';showMessage('New empty practice created');state.setupStep='activities';render();" class="p-6 bg-gray-900 rounded-2xl border-2 border-blue-500/20 hover:border-blue-500 text-center transition-all group active:scale-95">
                                <div class="text-blue-400 font-black mb-2 group-hover:scale-110 transition-transform">TEAM PRACTICE</div>
                                <div class="text-[10px] opacity-40 uppercase font-bold tracking-widest">Manual Builder</div>
                            </button>
                            <button onclick="state.currentPlanId=null;state.practiceName='';state.showSplitSelector=true;render();" class="p-6 bg-gray-900 rounded-2xl border-2 border-yellow-500/20 hover:border-yellow-500 text-center transition-all group active:scale-95">
                                <div class="text-yellow-500 font-black mb-2 group-hover:scale-110 transition-transform">GROUP SPLIT</div>
                                <div class="text-[10px] opacity-40 uppercase font-bold tracking-widest">Station Rotation</div>
                            </button>
                            <button onclick="state.currentPlanId=null;state.practiceName='';loadTemplate('comp-warmup')" class="p-6 bg-gray-900 rounded-2xl border-2 border-red-500/20 hover:border-red-500 text-center transition-all group active:scale-95">
                                <div class="text-red-500 font-black mb-2 group-hover:scale-110 transition-transform">COMP WARMUP</div>
                                <div class="text-[10px] opacity-40 uppercase font-bold tracking-widest">High Intensity</div>
                            </button>
                            <button onclick="state.currentPlanId=null;state.practiceName='';loadTemplate('comp-cooldown')" class="p-6 bg-gray-900 rounded-2xl border-2 border-cyan-400/20 hover:border-cyan-400 text-center transition-all group active:scale-95">
                                <div class="text-cyan-400 font-black mb-2 group-hover:scale-110 transition-transform">COMP COOLDOWN</div>
                                <div class="text-[10px] opacity-40 uppercase font-bold tracking-widest">Recovery Flow</div>
                            </button>
                            <!-- HISTORY BUTTON -->
                            <button onclick="handleHistoryClick()" class="p-6 bg-gray-900 rounded-2xl border-2 border-purple-500/20 hover:border-purple-500 text-center transition-all group active:scale-95">
                                <div class="text-purple-500 font-black mb-2 group-hover:scale-110 transition-transform">HISTORY</div>
                                <div class="text-[10px] opacity-40 uppercase font-bold tracking-widest">Load Past Plan</div>
                            </button>
                        </div>
                    </div>

                    <button onclick="state.setupStep='activities';render();" class="w-full bg-yellow-500 text-black py-6 rounded-3xl text-2xl font-black uppercase shadow-xl hover:scale-[1.01] transition-transform active:scale-95">Skip to Library &rarr;</button>
                </div>

                ${state.showSplitSelector ? renderSplitSelector() : ''}
                ${state.showHistory ? renderHistoryModal() : ''}
                ${state.showLoginModal ? renderLoginModal() : ''}
                ${state.showAccountModal ? renderAccountModal() : ''}
            `;
        }

        function renderLibrary() {
            const all = [...presetActivities, ...state.customActivities];
            const categories = [...new Set(all.map(a => a.category))];
            const selCount = Object.keys(state.selectedPresets).length;

            return `
                <div class="space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-center bg-gray-800 p-6 rounded-3xl border-2 border-blue-500 gap-4">
                        <div><h2 class="text-2xl font-black uppercase text-blue-400 tracking-tighter">Drill Library</h2><p class="text-xs opacity-50">Tap cards to select</p></div>
                        <div class="flex gap-2">
                            ${window.currentUser ? `<button id="push-presets-btn" onclick="pushPresetsToCloud()" class="bg-gray-700 px-6 py-2 rounded-xl font-bold uppercase text-xs border border-white/10 hover:bg-gray-600 transition-colors">Push Presets to Cloud</button>` : ''}
                            <button onclick="state.showCustomForm=!state.showCustomForm;render();" class="bg-blue-600 px-6 py-2 rounded-xl font-bold uppercase text-xs">New Custom Move</button>
                        </div>
                    </div>

                    ${state.showCustomForm ? `
                        <div class="bg-gray-800 p-6 rounded-3xl border-2 border-yellow-500 grid grid-cols-1 md:grid-cols-3 gap-4 shadow-2xl">
                            <input id="c-title" placeholder="Move Name" class="bg-gray-900 p-4 rounded-xl border border-gray-700 text-white" />
                            <input id="c-dur" type="number" value="5" class="bg-gray-900 p-4 rounded-xl border border-gray-700 text-white" />
                            <select id="c-cat" class="bg-gray-900 p-4 rounded-xl border border-gray-700 text-white">
                                <option>Neutral / Offense</option><option>Top</option><option>Bottom</option><option>Conditioning</option><option>Cool Down</option>
                            </select>
                            <button onclick="addCustomDrill()" class="md:col-span-3 bg-green-600 py-4 rounded-xl font-black">SAVE TO LIBRARY</button>
                        </div>
                    ` : ''}

                    <div class="space-y-10">
                        ${categories.map(cat => `
                            <div>
                                <h3 class="text-sm font-black uppercase text-yellow-400 mb-4 border-l-4 border-yellow-500 pl-3">${cat} Drills</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${all.filter(a => a.category === cat).map(a => `
                                        <button onclick="togglePreset('${a.id}')" class="p-4 rounded-2xl text-left border-2 transition-all ${state.selectedPresets[a.id] ? 'bg-yellow-500 border-yellow-300 text-black scale-105 shadow-xl' : 'bg-gray-800 border-gray-700 hover:border-blue-500 text-white'}">
                                            <div class="font-black uppercase tracking-tight truncate">${a.title}</div>
                                            <div class="text-[10px] mt-1 opacity-60">${a.duration}m • ${a.description || cat}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ${selCount > 0 ? `<div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-full max-w-lg px-4 z-[60]"><button onclick="addSelectedToSchedule()" class="w-full bg-blue-600 py-6 rounded-3xl font-black text-xl border-4 border-blue-400 shadow-2xl shadow-blue-500/30 uppercase tracking-tighter text-white">ADD ${selCount} DRILLS TO PRACTICE</button></div>` : ''}
            `;
        }

        function renderSchedule() {
            return `
                <div class="space-y-6 pb-20">
                    <!-- Header with Total Stats and Actions -->
                    <div class="flex flex-col md:flex-row justify-between items-center bg-gray-800 p-8 rounded-3xl border-2 border-yellow-500 shadow-xl gap-4">
                        <div class="text-center md:text-left">
                            <h2 class="text-3xl font-black uppercase text-yellow-400 italic">Review Final Schedule</h2>
                            <div class="text-xs font-bold uppercase text-gray-400 mt-1">${state.activities.length} Drills Organized • ${getTotalDuration()} Minutes Total</div>
                        </div>
                        <div class="flex gap-2">
                             <!-- NEW BUTTON HERE -->
                             <button id="save-plan-btn" onclick="savePracticePlan()" class="bg-gray-700 text-white px-6 py-3 rounded-2xl font-black uppercase text-sm hover:bg-gray-600 transition-all flex items-center gap-2 shadow-lg border border-white/20">
                                Save Plan
                            </button>
                            <button id="cal-upload-btn" onclick="uploadToCalendar()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black uppercase text-sm hover:bg-blue-500 transition-all flex items-center gap-2 shadow-lg">
                                Upload to Calendar
                            </button>
                             <button onclick="generatePrintPlan()" class="bg-white text-black px-6 py-3 rounded-2xl font-black uppercase text-sm hover:bg-gray-200 transition-all flex items-center gap-2 shadow-lg">
                                Print Plan
                            </button>
                        </div>
                    </div>

                    ${state.activities.length > 0 ? `
                        <div class="space-y-3">
                            ${state.activities.map((a, idx) => `
                                <div class="bg-gray-800/80 p-5 rounded-2xl border border-white/5 flex flex-col md:flex-row items-center gap-4 relative group">
                                    <div class="flex flex-row md:flex-col gap-1 opacity-100 md:opacity-40 group-hover:opacity-100 transition-opacity">
                                        <button onclick="moveDrill(${idx}, -1)" class="text-blue-500 hover:text-white" ${idx === 0 ? 'disabled' : ''}>▲</button>
                                        <button onclick="moveDrill(${idx}, 1)" class="text-blue-500 hover:text-white" ${idx === state.activities.length - 1 ? 'disabled' : ''}>▼</button>
                                    </div>
                                    <div class="w-10 font-black text-3xl text-blue-500/50">${idx + 1}</div>
                                    <div class="flex-1 w-full">
                                        ${a.type === 'station' ? `
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="font-black uppercase text-yellow-500 tracking-tight">Group Split Rotation</div>
                                                <div class="flex items-center bg-gray-900 rounded-lg border border-white/10 overflow-hidden">
                                                    <button onclick="updateDrillDuration(${idx}, -1)" class="px-3 py-1 hover:bg-white/10 text-yellow-400 font-bold transition-colors">-</button>
                                                    <span class="text-xs font-bold px-2 text-white min-w-[3rem] text-center">${a.duration}m</span>
                                                    <button onclick="updateDrillDuration(${idx}, 1)" class="px-3 py-1 hover:bg-white/10 text-yellow-400 font-bold transition-colors">+</button>
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 mt-3">
                                                ${a.groups.map((g, gi) => `
                                                    <div onclick="editStationGroup(${idx}, ${gi})" class="${g.id ? 'bg-gray-900 border-white/5' : 'bg-gray-900/50 border-yellow-500/50 border-dashed animate-pulse'} p-3 rounded-xl text-[10px] border cursor-pointer hover:bg-blue-600/20 hover:border-blue-500 transition-all">
                                                        <span class="font-black text-blue-400 uppercase tracking-widest">GRP ${String.fromCharCode(65+gi)}</span><br/>

                                                        <span class="font-bold ${g.id ? 'text-white' : 'text-yellow-500 italic'} uppercase">${g.title}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : `
                                            <div class="font-black uppercase tracking-tight text-lg">${a.title}</div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="text-[10px] font-black uppercase text-gray-500">${a.category}</span>
                                                <span class="text-gray-600">•</span>
                                                <div class="flex items-center bg-gray-900 rounded-lg border border-white/10 overflow-hidden">
                                                    <button onclick="updateDrillDuration(${idx}, -1)" class="px-2 py-0.5 hover:bg-white/10 text-blue-400 font-bold transition-colors">-</button>
                                                    <span class="text-xs font-bold px-2 text-white min-w-[2.5rem] text-center">${a.duration}m</span>
                                                    <button onclick="updateDrillDuration(${idx}, 1)" class="px-2 py-0.5 hover:bg-white/10 text-blue-400 font-bold transition-colors">+</button>
                                                </div>
                                            </div>
                                        `}
                                        <!-- NOTES FIELD -->
                                        <div class="mt-2">
                                            <input 
                                                type="text" 
                                                placeholder="Add notes (e.g. 'Focus on hand fighting')..." 
                                                value="${a.notes || ''}" 
                                                oninput="updateDrillNote(${idx}, this.value)"
                                                class="w-full bg-gray-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-white placeholder-gray-600 focus:border-blue-500 focus:outline-none transition-colors"
                                            />
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-2">
                                        <!-- DUPLICATE BUTTON -->
                                        <button onclick="duplicateDrill(${idx})" title="Duplicate Drill" class="p-2 text-gray-500 hover:text-blue-400 transition-colors bg-gray-900 rounded-lg border border-white/5">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                        
                                        <!-- DELETE BUTTON -->
                                        <button onclick="state.activities.splice(${idx},1);render();" title="Remove Drill" class="p-2 text-gray-500 hover:text-red-500 transition-colors bg-gray-900 rounded-lg border border-white/5">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                            
                            <button onclick="startPractice()" class="w-full bg-green-600 py-10 rounded-[3rem] text-4xl font-black uppercase italic shadow-2xl border-b-[12px] border-green-800 active:border-b-0 active:translate-y-2 transition-all mt-10">START PRACTICE SESSION</button>
                        </div>
                    ` : `
                        <div class="bg-gray-800/20 border-2 border-dashed border-gray-700 p-20 rounded-[3rem] text-center text-gray-500 font-black uppercase tracking-widest italic">
                            Practice schedule empty.<br/>Return to Step 1 or 2 to add drills.
                        </div>
                    `}
                </div>

                ${state.stationEditId !== null ? renderStationAssignModal() : ''}
            `;
        }

        function renderSplitSelector() {
            return `
                <div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/95 backdrop-blur-md">
                    <div class="bg-gray-800 rounded-[3rem] border-4 border-yellow-500 p-12 text-center space-y-8 shadow-[0_0_50px_rgba(234,179,8,0.3)]">
                        <h3 class="text-4xl font-black uppercase italic text-yellow-500 tracking-tighter">Setup Stations</h3>
                        
                        <!-- Rotations Selector -->
                        <div class="bg-gray-900/50 p-6 rounded-2xl border border-white/5">
                            <label class="block text-xs font-bold uppercase text-gray-400 mb-4">Rotations (Drills per Group)</label>
                            <div class="flex items-center justify-center gap-6">
                                <button onclick="state.tempRotationCount = Math.max(1, state.tempRotationCount - 1); render();" class="w-16 h-16 rounded-2xl bg-gray-800 border border-gray-600 hover:bg-gray-700 text-3xl font-black text-white transition-all">-</button>
                                <span class="text-6xl font-mono font-black text-blue-400 w-24">${state.tempRotationCount}</span>
                                <button onclick="state.tempRotationCount = Math.min(10, state.tempRotationCount + 1); render();" class="w-16 h-16 rounded-2xl bg-gray-800 border border-gray-600 hover:bg-gray-700 text-3xl font-black text-white transition-all">+</button>
                            </div>
                        </div>

                        <!-- Group Selector -->
                        <div class="space-y-4">
                            <div class="text-xs font-bold uppercase text-gray-400">Select Number of Groups to Create</div>
                            <div class="flex gap-3 justify-center flex-wrap">
                                ${[2, 3, 4, 5, 6].map(num => `
                                    <button onclick="createGroupSplit(${num})" class="w-20 h-20 rounded-3xl bg-gray-900 border-2 border-white/10 hover:border-blue-500 hover:text-blue-400 text-3xl font-black transition-all hover:scale-110 shadow-xl hover:shadow-blue-500/20">${num}</button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button onclick="state.showSplitSelector=false;state.tempRotationCount=1;render();" class="text-xs uppercase font-black text-gray-600 hover:text-white transition-colors">Cancel</button>
                    </div>
                </div>
            `;
        }

        function createGroupSplit(numGroups) {
            const rotations = state.tempRotationCount || 1;
            
            for (let r = 0; r < rotations; r++) {
                const groups = [];
                for(let i=0; i<numGroups; i++) {
                    groups.push({ 
                        title: `TAP TO ASSIGN`, 
                        description: `Group ${String.fromCharCode(65+i)} - Drill ${r+1}`, 
                        id: null 
                    });
                }
                state.activities.push({ 
                    type: 'station', 
                    id: 'station'+Date.now()+'_'+r, 
                    duration: 10, 
                    groups: groups,
                    notes: `Rotation ${r+1} of ${rotations}`
                });
            }
            
            state.showSplitSelector = false;
            state.setupStep = 'schedule'; 
            state.tempRotationCount = 1; // Reset
            showMessage(`Created ${rotations} rotation blocks!`, 'success');
            render();
        }

        function renderStationAssignModal() {
            const { aidx, gidx } = state.stationEditId;
            const all = [...presetActivities, ...state.customActivities];
            return `
                <div class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div class="bg-gray-800 rounded-[3rem] border-2 border-blue-500 w-full max-w-3xl max-h-[85vh] flex flex-col shadow-2xl">
                        <div class="p-8 border-b border-white/10 flex justify-between items-center bg-gray-900/50">
                            <h3 class="text-3xl font-black uppercase italic">Group ${String.fromCharCode(65+gidx)} Move</h3>
                            <button onclick="state.stationEditId=null;render();" class="text-3xl font-bold">✕</button>
                        </div>
                        <div class="p-8 overflow-y-auto custom-scrollbar grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                            ${all.map(a => `<button onclick="assignToStation(${aidx}, ${gidx}, '${a.id}')" class="p-5 bg-gray-900 rounded-2xl text-left hover:bg-blue-600 transition-all border border-white/5 group shadow-md"><div class="text-[10px] uppercase font-black opacity-30 group-hover:opacity-100">${a.category}</div><div class="font-black text-xs uppercase mt-1">${a.title}</div></button>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistoryModal() {
            return `
                <div class="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div class="bg-gray-800 rounded-[3rem] border-4 border-purple-500 w-full max-w-4xl max-h-[85vh] flex flex-col shadow-[0_0_50px_rgba(168,85,247,0.3)]">
                        <div class="p-8 border-b border-white/10 flex justify-between items-center bg-gray-900/50 rounded-t-[3rem]">
                            <div>
                                <h3 class="text-4xl font-black uppercase italic text-purple-400 tracking-tighter">Practice History</h3>
                                <p class="text-xs opacity-50 mt-1 uppercase tracking-widest">Select a past plan to load</p>
                            </div>
                            <button onclick="state.showHistory=false;render();" class="p-4 bg-gray-900 rounded-full hover:bg-gray-700 transition-colors">✕</button>
                        </div>
                        <div class="p-8 overflow-y-auto custom-scrollbar space-y-4">
                            ${state.isLoadingHistory ? '<div class="text-center py-10 opacity-50 animate-pulse">Loading history...</div>' : ''}
                            
                            ${!state.isLoadingHistory && state.history.length === 0 ? '<div class="text-center py-20 opacity-30 uppercase font-black tracking-widest">No saved practices found</div>' : ''}

                            ${state.history.map(plan => {
                                const activitySummary = plan.activities.slice(0, 3).map(a => a.type === 'station' ? 'Stations' : a.title).join(', ') + (plan.activities.length > 3 ? ` + ${plan.activities.length - 3} more` : '');
                                const planName = plan.name ? `<div class="text-white text-lg font-bold italic mb-1">"${plan.name}"</div>` : '';
                                return `
                                    <div class="bg-gray-900 p-6 rounded-2xl border border-white/5 flex flex-col md:flex-row justify-between items-center gap-6 group hover:border-purple-500 transition-all">
                                        <div class="flex-1 text-center md:text-left">
                                            ${planName}
                                            <div class="flex items-center justify-center md:justify-start gap-3 mb-1">
                                                <div class="font-black text-xl uppercase text-white">${plan.date || 'Unknown Date'}</div>
                                                <div class="text-xs font-bold px-2 py-1 bg-gray-800 rounded text-purple-400">${plan.totalDuration}m</div>
                                            </div>
                                            <div class="text-sm opacity-60 uppercase font-bold tracking-wide text-gray-400">${activitySummary}</div>
                                            <div class="text-[10px] opacity-30 mt-2 font-mono">ID: ${plan.id.substring(0,8)}...</div>
                                        </div>
                                        <div class="flex gap-3">
                                            <button onclick="deleteHistoryItem('${plan.id}')" class="px-4 py-3 bg-gray-800 hover:bg-red-900/50 text-red-500 rounded-xl font-bold uppercase text-xs transition-colors border border-transparent hover:border-red-500/50">
                                                Delete
                                            </button>
                                            <button onclick="loadHistoryItem('${plan.id}')" class="px-8 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-xl font-black uppercase text-sm transition-all shadow-lg shadow-purple-900/20 hover:scale-105 active:scale-95">
                                                Load Plan
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLive() {
            const isDone = state.currentActivityIndex >= state.activities.length;
            const cur = isDone ? null : state.activities[state.currentActivityIndex];
            const next = isDone ? null : state.activities[state.currentActivityIndex+1];
            const remSecs = cur ? (cur.duration * 60) - state.elapsedSeconds : 0;

            let liveContent = '';
            if (isDone) {
                liveContent = `<div class="text-9xl font-black text-yellow-400 italic">FINISH</div><p class="text-3xl mt-4 opacity-50 uppercase tracking-widest font-black italic">Practice Complete</p>`;
            } else if (cur.type === 'station') {
                const count = cur.groups.length;
                const gridClass = count <= 2 ? 'grid-cols-1 md:grid-cols-2' : (count <= 4 ? 'grid-cols-2' : 'grid-cols-2 md:grid-cols-3');
                liveContent = `
                    <div class="grid ${gridClass} gap-4 w-full h-full flex-1 mb-6">
                        ${cur.groups.map((g, i) => `
                            <div class="bg-gray-900/50 rounded-[2rem] border-2 border-blue-500/50 p-6 flex flex-col items-center justify-center text-center shadow-lg backdrop-blur">
                                <div class="text-blue-500 font-black text-sm mb-2 tracking-widest">GROUP ${String.fromCharCode(65+i)}</div>
                                <div class="text-xl md:text-3xl font-black uppercase leading-tight">${g.title}</div>
                                <div class="text-[10px] opacity-40 mt-2 uppercase font-bold">${g.description || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-[10rem] font-mono leading-none text-yellow-400 font-black">${formatTime(remSecs)}</div>
                `;
            } else {
                liveContent = `
                    <div class="text-blue-500 font-black tracking-[1em] mb-4 uppercase text-lg">Active Move</div>
                    <div class="text-6xl md:text-[10rem] font-black uppercase mb-10 leading-none tracking-tighter italic">${cur.title}</div>
                    ${cur.notes ? `<div class="text-2xl font-bold text-yellow-400 mb-6 bg-gray-900/50 px-6 py-2 rounded-xl border border-white/10">NOTE: ${cur.notes}</div>` : ''}
                    <div class="bg-gray-900/80 p-16 rounded-[4rem] border-4 border-white/5 relative shadow-inner w-full max-w-4xl">
                        <div class="text-[12rem] md:text-[18rem] font-mono leading-none font-black ${remSecs < 10 ? 'text-red-500 animate-pulse-fast' : 'text-yellow-400'}">${formatTime(remSecs)}</div>
                    </div>
                `;
            }

            return `
                <div class="flex-1 bg-black p-4 flex flex-col gap-6 font-black overflow-hidden h-screen">
                    <div class="flex justify-between items-center text-xs text-gray-700 uppercase">
                        <div>Live Session Engine v5.0</div>
                        <div class="font-mono text-white/40">${new Date().toLocaleTimeString()}</div>
                    </div>
                    
                    <div class="h-6 bg-gray-950 rounded-full border-2 border-gray-900 overflow-hidden shrink-0">
                        <div class="h-full bg-gradient-to-r from-blue-700 via-blue-500 to-yellow-500 transition-all duration-1000 shadow-[0_0_30px_rgba(59,130,246,0.3)]" style="width: ${getProgressPercentage()}%"></div>
                    </div>

                    <div class="flex-1 flex flex-col items-center justify-center text-center">
                        ${liveContent}
                        <!-- Time Adjustments -->
                        ${!isDone ? `
                            <div class="flex gap-4 mt-6">
                                <button onclick="adjustLiveTime(-1)" class="px-6 py-3 rounded-xl border border-white/10 bg-gray-900 hover:bg-red-900/50 text-white font-bold transition-all">-1m</button>
                                <button onclick="adjustLiveTime(1)" class="px-6 py-3 rounded-xl border border-white/10 bg-gray-900 hover:bg-green-900/50 text-white font-bold transition-all">+1m</button>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Shark Bait Control -->
                    ${!isDone ? `
                        <div class="flex justify-center mb-2">
                            <div class="bg-gray-900/80 rounded-xl border border-white/5 p-2 flex items-center gap-2">
                                <span class="text-[10px] uppercase font-bold text-gray-500 px-2">Shark Bait Interval</span>
                                ${[0, 15, 30, 60].map(val => `
                                    <button onclick="state.liveInterval=${val};render();" class="px-3 py-1 rounded-lg text-xs font-bold transition-colors ${state.liveInterval === val ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}">
                                        ${val === 0 ? 'OFF' : val + 's'}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-gray-950 p-6 rounded-[4rem] border-t-2 border-white/5 shrink-0 flex items-center justify-between px-10">
                        <div class="flex-1">
                            <div class="text-blue-500 text-[10px] uppercase mb-1">Up Next</div>
                            <div class="font-black text-2xl uppercase italic truncate max-w-[200px]">${next ? next.title : 'Finish'}</div>
                        </div>
                        <div class="flex items-center gap-6 flex-1 justify-center">
                            <button onclick="state.currentActivityIndex=Math.max(0, state.currentActivityIndex-1);state.elapsedSeconds=0;render();" class="p-5 bg-gray-900 rounded-full text-white/30 hover:text-white transition-colors"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m11 17-5-5 5-5M18 17l-5-5 5-5"/></svg></button>
                            <button onclick="toggleTimer()" class="p-14 rounded-full border-8 border-white/10 shadow-2xl transition-all active:scale-95 ${state.isRunning ? 'bg-yellow-500 text-black' : 'bg-blue-600 text-white'}">
                                ${state.isRunning ? '<svg width="60" height="60" viewBox="0 0 24 24" fill="currentColor"><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>' : '<svg width="60" height="60" viewBox="0 0 24 24" fill="currentColor"><path d="m5 3 14 9-14 9V3z"/></svg>'}
                            </button>
                            <button onclick="state.currentActivityIndex=Math.min(state.activities.length, state.currentActivityIndex+1);state.elapsedSeconds=0;render();" class="p-5 bg-gray-900 rounded-full text-white/30 hover:text-white transition-colors"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m13 17 5-5-5-5M6 17l5-5-5-5"/></svg></button>
                        </div>
                        <div class="flex-1 text-right"> 
                            <button onclick="exitSession()" class="bg-gray-900 px-6 py-4 rounded-3xl text-[10px] uppercase font-black tracking-widest border border-white/5 hover:bg-red-950 transition-colors">Exit Session</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Interaction Handlers ---
        function togglePreset(id) {
            if (state.selectedPresets[id]) delete state.selectedPresets[id];
            else {
                const item = [...presetActivities, ...state.customActivities].find(x => x.id === id);
                state.selectedPresets[id] = { ...item };
            }
            render();
        }

        function addSelectedToSchedule() {
            const toAdd = Object.values(state.selectedPresets).map(p => {
                const list = [{...p, id: 'inst'+Math.random()}];
                if (state.options.autoRestSeconds > 0) list.push({ id: 'rest'+Math.random(), title: 'Rest', category: 'Rest', duration: state.options.autoRestSeconds/60 });
                return list;
            }).flat();
            state.activities.push(...toAdd);
            state.selectedPresets = {}; 
            state.setupStep = 'schedule'; 
            render();
        }

        function editStationGroup(aidx, gidx) { state.stationEditId = { aidx, gidx }; render(); }
        function assignToStation(aidx, gidx, pid) {
            const move = [...presetActivities, ...state.customActivities].find(x => x.id === pid);
            state.activities[aidx].groups[gidx] = { ...move };
            state.stationEditId = null;
            render();
        }

        function loadTemplate(type) {
            let activities = [];
            let name = '';
            
            if (type === 'comp-warmup') {
                activities = [
                    { title: 'Dynamic Warm-up', duration: 10, category: 'Neutral / Offense' },
                    { title: 'Stance & Motion', duration: 5, category: 'Neutral / Offense' },
                    { title: 'Hard Speed Shots', duration: 5, category: 'Neutral / Offense' },
                    { title: 'Clearance Drills', duration: 5, category: 'Neutral / Offense' },
                    { title: 'Mental Prep / Chalk Talk', duration: 5, category: 'Specials' }
                ];
                name = 'Comp Warmup';
            } else if (type === 'comp-cooldown') {
                activities = [
                    { title: 'Light Shadow Wrestling', duration: 3, category: 'Cool Down' },
                    { title: 'Partner Static Stretching', duration: 7, category: 'Cool Down' },
                    { title: 'Deep Breathing / Reflection', duration: 5, category: 'Cool Down' }
                ];
                name = 'Comp Cooldown';
            } else if (type === 'kjays-essentials') {
                // Break out the 6 essentials individually
                activities = [
                   { title: 'Leap Frog Shot', duration: 2, category: 'Neutral / Offense' },
                   { title: 'Diamond Build Ups', duration: 2, category: 'Bottom' },
                   { title: 'Short Sit Crab to Bear Knee Jam', duration: 2, category: 'Bottom' },
                   { title: 'Sprawl Push Aways', duration: 2, category: 'Neutral / Offense' },
                   { title: 'Bridge Circles', duration: 2, category: 'Conditioning' },
                   { title: 'Chest Spin', duration: 2, category: 'Neutral / Offense' }
                ];
                name = 'K-Jays 6 Essentials';
            } else if (type === 'kjays-ninja') {
                // FULL BREAKDOWN OF NINJA TRAINING
                activities = [
                    { title: 'Forward Rolls', duration: 1, category: 'Conditioning' },
                    { title: 'Backwards Rolls', duration: 1, category: 'Conditioning' },
                    { title: 'Cart Wheels', duration: 1, category: 'Conditioning' },
                    { title: 'Lateral Glides', duration: 1, category: 'Conditioning' },
                    { title: 'Bear Crawl', duration: 1, category: 'Conditioning' },
                    { title: 'Gorilla Walk', duration: 1, category: 'Conditioning' },
                    { title: 'Duck Walk', duration: 1, category: 'Conditioning' },
                    { title: 'Head Springs', duration: 1, category: 'Conditioning' },
                    { title: 'One Leg Hop', duration: 1, category: 'Conditioning' },
                    { title: 'Knee to Feet Explosions', duration: 1, category: 'Conditioning' },
                    { title: 'High Knees', duration: 1, category: 'Conditioning' },
                    { title: 'Butt Kickers', duration: 1, category: 'Conditioning' },
                    { title: 'Forward Skip', duration: 1, category: 'Conditioning' },
                    { title: 'Standing Broad Jump', duration: 1, category: 'Conditioning' },
                    { title: 'Bunny Hops', duration: 1, category: 'Conditioning' },
                    { title: 'Sprints', duration: 1, category: 'Conditioning' },
                    { title: 'Backwards Sprint', duration: 1, category: 'Conditioning' },
                    { title: 'Crab Walk', duration: 1, category: 'Conditioning' },
                    { title: 'Knee Running', duration: 1, category: 'Conditioning' },
                    { title: 'Sideways Plank Walk', duration: 1, category: 'Conditioning' },
                    { title: 'Seal Crawl', duration: 1, category: 'Conditioning' }
                ];
                name = 'K-Jays Ninja Training';
            } else if (type === 'kjays-day3') {
                activities = [
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Ninja Training Circuit', duration: 10, category: 'Specials' },
                    { title: 'Ankle Tag', duration: 10, category: 'Neutral / Offense', notes: 'Snap if too low for ankle Double Tie' },
                    { title: 'Stuff Head / Push Knees', duration: 10, category: 'Bottom', notes: 'Sprawl Double/Single' },
                    { title: 'Mat Return', duration: 10, category: 'Top', notes: 'Break Table Ankle' },
                    { title: 'Half / Counter Half', duration: 10, category: 'Top', notes: 'Keep Flat' },
                    { title: 'Quadpod Knee Jam', duration: 10, category: 'Bottom', notes: 'Sit out (hip heist)' },
                    { title: 'Finish Talk', duration: 5, category: 'Specials', notes: 'What was fun tonight?' },
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Clean Up', duration: 15, category: 'Specials' }
                ];
                name = 'K-Jays Day 3';
            } else if (type === 'kjays-day4') {
                activities = [
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Ninja Training Circuit', duration: 10, category: 'Specials' },
                    { title: 'Triangle Series', duration: 10, category: 'Top', notes: 'Ankle Tag / Head position / Knees' },
                    { title: 'Sprawl Front Headlock', duration: 10, category: 'Neutral / Offense', notes: 'Circle Circle chase ankles' },
                    { title: 'Counter Half', duration: 10, category: 'Top' },
                    { title: 'Diamond Build Up', duration: 10, category: 'Bottom' },
                    { title: 'Live Scenarios', duration: 10, category: 'Neutral / Offense' },
                    { title: 'Finish Talk', duration: 5, category: 'Specials', notes: 'What was fun tonight?' },
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Clean Up', duration: 15, category: 'Specials' }
                ];
                name = 'K-Jays Day 4';
            } else if (type === 'kjays-day5') {
                 activities = [
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Ninja Training Circuit', duration: 10, category: 'Specials' },
                    { title: 'Double Tie', duration: 10, category: 'Neutral / Offense', notes: 'Snap or Ankle / Good stance hand fight' },
                    { title: 'Defense', duration: 10, category: 'Neutral / Offense', notes: 'Double/Single push knees, spin' },
                    { title: 'Break Table', duration: 10, category: 'Top', notes: 'Pick, Far Far' },
                    { title: 'Keep Flat', duration: 10, category: 'Top', notes: 'Blanket use head and toes Half/Counter' },
                    { title: 'Movement w/ Hand Control', duration: 10, category: 'Bottom', notes: 'Change over, quad, sit, heist' },
                    { title: 'Finish Talk', duration: 5, category: 'Specials', notes: 'What was fun tonight?' },
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Clean Up', duration: 15, category: 'Specials' }
                ];
                name = 'K-Jays Day 5';
            } else if (type === 'kjays-day6') {
                 activities = [
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Ninja Training Circuit', duration: 10, category: 'Specials' },
                    { title: 'Ankle Tag', duration: 10, category: 'Neutral / Offense', notes: 'Head position / Knees Triangle series' },
                    { title: 'Defense', duration: 10, category: 'Neutral / Offense', notes: 'Pressure, light on toes Double /Single' },
                    { title: 'Break Table', duration: 10, category: 'Top', notes: 'Returns, Ankles, Far Far' },
                    { title: 'Keep Flat', duration: 10, category: 'Top', notes: 'Run Wrists' },
                    { title: 'Build Up', duration: 10, category: 'Bottom', notes: 'Sit, Heist, Quad, Roll' },
                    { title: 'Finish Talk', duration: 5, category: 'Specials', notes: 'What was fun tonight?' },
                    { title: 'K-Jays 6 Essentials Circuit', duration: 15, category: 'Specials' },
                    { title: 'Clean Up', duration: 15, category: 'Specials' }
                ];
                name = 'K-Jays Day 6';
            }
            
            state.activities = activities.map(a => ({...a, id: 'tmp'+Math.random()}));
            state.currentPlanId = null;
            state.practiceName = name;
            state.setupStep = 'schedule';
            showMessage(`${name} template loaded!`, 'success');
            render();
        }
        
        function toggleTimer() {
            if(state.isRunning) pauseTimer();
            else startTimer();
            render();
        }

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) state.customActivities = JSON.parse(saved);
            
            // Restore active session
            restoreActiveSession();
            
            render();
        };
    </script>
</body>
</html>
